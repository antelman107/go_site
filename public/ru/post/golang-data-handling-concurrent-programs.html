

<!DOCTYPE html>
<html lang="ru-ru" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=51376&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="content-type" content="text/html; charset=utf-8" />

<title>Обработка данных в конкурентных программах | Golang for all</title>




  






  
  
    
  








  



<meta name="description" content="В Go у нас есть функциональность горутин из коробки. Мы можем запускать код параллельно. Однако в нашем параллельно выполняющемся коде мы можем работать с …">


<meta property="og:type" content="article">
<meta property="og:url" content="http://localhost:51376/ru/post/golang-data-handling-concurrent-programs.html">
<meta property="og:title" content="Обработка данных в конкурентных программах | Golang for all">
<meta property="og:description" content="В Go у нас есть функциональность горутин из коробки. Мы можем запускать код параллельно. Однако в нашем параллельно выполняющемся коде мы можем работать с …">
<meta property="og:image" content="http://localhost:51376/en/post/golang-data-handling-concurrent-programs/kanat.svg">
<meta property="og:site_name" content="Golang for all">
<meta property="og:locale" content="ru">

  
    <meta property="article:published_time" content="2020-04-02T09:00:00&#43;03:00">
  
  
    <meta property="article:modified_time" content="2020-04-02T09:00:00&#43;03:00">
  
  
    
      <meta property="article:tag" content="Map">
    
      <meta property="article:tag" content="Sources">
    
  



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:url" content="http://localhost:51376/ru/post/golang-data-handling-concurrent-programs.html">
<meta name="twitter:title" content="Обработка данных в конкурентных программах | Golang for all">
<meta name="twitter:description" content="В Go у нас есть функциональность горутин из коробки. Мы можем запускать код параллельно. Однако в нашем параллельно выполняющемся коде мы можем работать с …">
<meta name="twitter:image" content="http://localhost:51376/en/post/golang-data-handling-concurrent-programs/kanat.svg">



<link rel="canonical" href="http://localhost:51376/ru/post/golang-data-handling-concurrent-programs.html">



  <link rel="alternate" hreflang="en" href="http://localhost:51376/en/post/golang-data-handling-concurrent-programs.html">


<meta name="yandex-verification" content="10233a4b32f4dc29" />
<meta name="yandex-verification" content="cfa4be404c1af368" />

<link rel="icon" type="image/png" sizes="93x93" href="/gophereye.png"/>
<link rel="icon" type="image/png" sizes="32x32" href="/gophereye32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/gophereye16x16.png">


    <link rel="stylesheet" href="/css/main.css">


      <script src="/js/main.js"></script>


<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.4.6/css/flag-icon.min.css" integrity="sha256-YjcCvXkdRVOucibC9I4mBS41lXPrWfqY2BnpskhZPnw=" crossorigin="anonymous" />


</head>
<body>
<div class="container">
    <nav class="navbar navbar-expand-lg navbar-light" style="padding-bottom: 0;">
        <div class="container">
            <a class="navbar-brand" href="/ru/" style="padding-bottom: 0">
                <img src="/verh.svg" alt="gopher eyes" style="height: 50px;"/>
            </a>

            <button class="navbar-toggler" type="button"
                    data-toggle="collapse"
                    data-target="#navbarResponsive"
                    aria-controls="navbarResponsive"
                    aria-expanded="false"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <a href="/ru/" style="color:#000;"><span class="gopherchat">Golang для всех</span></a>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="/ru/about.html">О сайте</a>
                    </li>
                    
                </ul>
            </div>
        </div>
    </nav>
</div>
<div class="bg-light">&nbsp;</div>

<div class="container">
    
<div class="col-lg-12">
    
    <h1 class="mt-4">Обработка данных в конкурентных программах</h1>

    
    <p>


  2 апреля 2020 г.



            <a href="/ru/tags/map/" class="badge">Map</a>
            <a href="/ru/tags/sources/" class="badge">Sources</a>
    </p>

    <hr/>

    
    
    
    <div class="container">
        <div class="row mx-0 my-0">
            <div class="col-md-8">
                <img class="img-fluid rounded"
                     style="max-height: 400px;"
                     src="/en/post/golang-data-handling-concurrent-programs/kanat.svg"
                     alt="Обработка данных в конкурентных программах"/>
            </div>
            <div class="col-md-4">
                
                
                <nav id="toc">
                    <h5>Содержание</h5>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#обнаружение-гонок-данных">Обнаружение гонок данных</a></li>
    <li><a href="#решение">Решение</a>
      <ul>
        <li><a href="#решение-syncmutexsyncrwmutex">Решение <code>sync.Mutex</code>/<code>sync.RWMutex</code></a></li>
        <li><a href="#решение-через-каналы">Решение через каналы</a></li>
        <li><a href="#решение-через-пакет-atomic">Решение через пакет atomic</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </nav>
                
            </div>
        </div>
    </div>
    <hr>
    
    

    <div id="post-content">
    <p>В Go у нас есть функциональность горутин из коробки. Мы можем запускать код параллельно. Однако в нашем параллельно выполняющемся коде мы можем работать с общими переменными, и не совсем понятно, как именно Go обрабатывает такие ситуации.</p>
<p>Начнём с задачи &ldquo;счётчик&rdquo; — попробуем увеличить переменную-счётчик 200 раз в нескольких горутинах.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 194</span>
</span></span></code></pre></div><p>Результирующее значение счётчика каждый раз отличается и в большинстве случаев не равно 200. Таким образом, этот код не является потокобезопасным и не работает как задумано, даже если у нас нет ошибок компилятора или времени выполнения.</p>
<p>Следующий случай — попробуем вставить 200 значений в срез параллельно и проверим, есть ли там ровно 200 значений.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">int</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span> = append(<span style="color:#a6e22e">c</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(len(<span style="color:#a6e22e">c</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 129</span>
</span></span></code></pre></div><p>Количество значений в срезе ещё дальше от 200, чем было в задаче со счётчиком. Этот код также не является потокобезопасным.</p>
<p>Попробуем вставить 200 значений в map параллельно:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">i</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	}(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(len(<span style="color:#a6e22e">c</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// panic: concurrent map writes</span>
</span></span></code></pre></div><p>Мы не можем проверить результат из-за паники.</p>
<p>Во всех 3 задачах у нас есть неработающий код, но только с map есть сообщение об ошибке о конкурентных записях в map, реализованное разработчиками Go.</p>
<h2 id="обнаружение-гонок-данных">Обнаружение гонок данных</h2>
<p>В Go есть инструмент для обнаружения таких ситуаций, называемый обнаружением гонок данных.</p>
<p>Можно запустить любой из приведённых выше тестовых случаев с флагом race — <code>go test -race ./test.go</code>. В результате Go отображает горутины с гонкой данных:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>go test -race ./test.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">==================</span>
</span></span><span style="display:flex;"><span>WARNING: DATA RACE
</span></span><span style="display:flex;"><span>Read at 0x00c0000a6070 by goroutine 9:
</span></span><span style="display:flex;"><span>command-line-arguments.Test.func1<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>/go/src/github.com/antelman107/go_blog/test.go:16 +0x38
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Previous write at 0x00c0000a6070 by goroutine 8:
</span></span><span style="display:flex;"><span>command-line-arguments.Test.func1<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>/go/src/github.com/antelman107/go_blog/test.go:16 +0x4e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Goroutine <span style="color:#ae81ff">9</span> <span style="color:#f92672">(</span>running<span style="color:#f92672">)</span> created at:
</span></span><span style="display:flex;"><span>command-line-arguments.Test<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>/go/src/github.com/antelman107/go_blog/test.go:15 +0xe8
</span></span><span style="display:flex;"><span>testing.tRunner<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>/usr/local/Cellar/go/1.14/libexec/src/testing/testing.go:992 +0x1eb
</span></span><span style="display:flex;"><span>--- FAIL: Test <span style="color:#f92672">(</span>0.01s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>testing.go:906: race detected during execution of test
</span></span><span style="display:flex;"><span>FAIL
</span></span><span style="display:flex;"><span>FAIL    command-line-arguments  0.025s
</span></span><span style="display:flex;"><span>FAIL
</span></span></code></pre></div><p>Обнаружение гонок данных — это не функциональность <code>go test</code>. Можно даже собрать программу в режиме обнаружения гонок:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go test -race mypkg    // для тестирования пакета
</span></span><span style="display:flex;"><span>$ go run -race .  // для запуска исходного файла
</span></span><span style="display:flex;"><span>$ go build -race .   // для сборки команды
</span></span><span style="display:flex;"><span>$ go install -race mypkg // для установки пакета
</span></span></code></pre></div><p>Хорошо, что можно напрямую обнаруживать гонки данных в программе.</p>
<p>Даже популярная проблема &ldquo;замыкания цикла&rdquo; может быть обнаружена:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span></code></pre></div><p>Проблема здесь в том, что код не выведет точные числа 0, 1, 2 &hellip; 9, а случайные числа от 0 до 9.</p>
<h2 id="решение">Решение</h2>
<p>Опишем решение для задачи со счётчиком. Это решение можно использовать для задач со срезом и map.</p>
<p>Итак, у нас есть значение счётчика, которое меньше ожидаемого.
Несмотря на краткость вызова инкремента (<code>c++</code>), программа фактически выполняет следующий список действий:</p>
<ol>
<li>чтение текущего значения счётчика из памяти,</li>
<li>его увеличение,</li>
<li>сохранение результата в память.</li>
</ol>
<p>Проблема возникает потому, что некоторые горутины читают одно и то же начальное значение счётчика. После чтения того же начального значения такие горутины изменяют его одинаковым образом. Это поведение объясняется на диаграмме:</p>
<p><img src="/en/post/golang-data-handling-concurrent-programs/nonatomic.svg" alt="nonatomic.svg"></p>
<p>Чем больше у нас таких ситуаций чтения одного и того же начального значения, тем больше результат счётчика отличается от 200.</p>
<p>Решением здесь может быть атомарное изменение переменной. Если какая-то горутина читает начальное значение счётчика, следующим действием должно быть единственное обновление счётчика от этой горутины. Ни одна из других горутин не должна обращаться к счётчику или изменять его в середине этой операции.</p>
<p>Если мы добавим логику синхронизации, как описано выше, диаграмма будет выглядеть следующим образом:</p>
<p><img src="/en/post/golang-data-handling-concurrent-programs/atomic.svg" alt="atomic.svg"></p>
<h3 id="решение-syncmutexsyncrwmutex">Решение <code>sync.Mutex</code>/<code>sync.RWMutex</code></h3>
<p>Мы можем использовать методы <code>Lock</code> и <code>Unlock</code> для гарантии того, что только одна горутина работает со счётчиком в каждый момент времени.</p>
<p>Мы также можем использовать <code>sync.RWMutex</code> для обеспечения параллельных чтений.</p>
<p>Но в нашей задаче Mutex полностью достаточен:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	}(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 200 == OK</span>
</span></span></code></pre></div><h3 id="решение-через-каналы">Решение через каналы</h3>
<p>Операции с каналами являются атомарными из коробки.</p>
<p>Мы можем отправлять любые данные в канал с одним читателем для обеспечения последовательной обработки.</p>
<p>Но для этого нам нужен дополнительный код:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}, <span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chanWg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chanWg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ch</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">chanWg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">struct</span>{}{}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	}(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>close(<span style="color:#a6e22e">ch</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">chanWg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 200 = OK</span>
</span></span></code></pre></div><p>Мы также использовали здесь пустую структуру, потому что это наименьший по размеру тип данных переменной в Go.</p>
<h3 id="решение-через-пакет-atomic">Решение через пакет atomic</h3>
<p>Стандартный пакет Go под названием <code>atomic</code> предоставляет набор атомарных операций.</p>
<p>Благодаря функциям <code>runtime_procPin</code> / <code>runtime_procUnpin</code> (в исходниках Go).</p>
<p>Функция <code>Pin</code> гарантирует, что планировщик Go не запустит никакую другую горутину до тех пор, пока не будет вызван <code>Unpin</code>.</p>
<p>У нас есть несколько функций счётчика в пакете atomic, которые помогают реализовать наш атомарный счётчик:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> int32(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>{}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt32</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">c</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
</span></span><span style="display:flex;"><span>	}(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 200 = OK</span>
</span></span></code></pre></div><p>Проблему атомарного изменения данных можно встретить во многих ситуациях разработки.
Например, та же проблема возникает с запросами SELECT + UPDATE в SQL базах данных при работе нескольких процессов.</p>
    
  <div>
    <div>Tags:</div>
    <ul>
        <li><a href="/ru/tags/map/">Map</a></li>
        <li><a href="/ru/tags/sources/">Sources</a></li>
    </ul>
  </div>

    </div>
    
<div id="article-quiz" class="mt-5 mb-5" data-quiz-lang="ru">
  <hr class="mb-4">
  <h3 class="mb-4">Проверьте свои знания</h3>
  
  <form id="quiz-form" data-quiz-data="{&#34;questions&#34;:[{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Значение счётчика будет меньше ожидаемого из-за гонок данных&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Программа вызовет панику&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Счётчик всегда будет правильным&#34;}],&#34;question&#34;:&#34;Что происходит, когда несколько горутин увеличивают переменную-счётчик без синхронизации?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;panic: concurrent map writes&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Карта будет пустой&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Ошибки нет, но результаты неверны&#34;}],&#34;question&#34;:&#34;Какая ошибка возникает, когда несколько горутин записывают в карту одновременно?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Использование `sync.Mutex`&#34;},{&#34;correct&#34;:true,&#34;text&#34;:&#34;Использование каналов&#34;},{&#34;correct&#34;:true,&#34;text&#34;:&#34;Использование пакета atomic&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Использование обычных переменных&#34;}],&#34;question&#34;:&#34;Каковы решения для потокобезопасных операций со счётчиком?&#34;,&#34;type&#34;:&#34;multiple-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Используя go test -race или go build -race&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Используя go vet&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Используя gofmt&#34;}],&#34;question&#34;:&#34;Как можно обнаружить гонки данных в программах Go?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Количество элементов будет меньше ожидаемого из-за гонок данных&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Программа вызовет панику&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Срез всегда будет содержать все элементы&#34;}],&#34;question&#34;:&#34;Что происходит при параллельной записи в срез без синхронизации?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Она состоит из трёх шагов: чтение, увеличение, запись&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Go не поддерживает атомарные операции&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Операция всегда атомарна&#34;}],&#34;question&#34;:&#34;Почему операция инкремента (c&#43;&#43;) не является атомарной?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;RWMutex позволяет параллельные чтения, Mutex блокирует все операции&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;RWMutex быстрее Mutex&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Нет разницы&#34;}],&#34;question&#34;:&#34;В чём разница между sync.Mutex и sync.RWMutex?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Это встроенная функциональность Go&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Каналы используют Mutex внутри&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Каналы работают только в одной горутине&#34;}],&#34;question&#34;:&#34;Почему операции с каналами являются атомарными?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;AddInt32&#34;},{&#34;correct&#34;:true,&#34;text&#34;:&#34;AddInt64&#34;},{&#34;correct&#34;:true,&#34;text&#34;:&#34;LoadInt32&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;SetInt32&#34;}],&#34;question&#34;:&#34;Какие функции предоставляет пакет atomic для работы со счётчиками?&#34;,&#34;type&#34;:&#34;multiple-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Отслеживает одновременный доступ к одной и той же памяти&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Проверяет синтаксис кода&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Анализирует производительность&#34;}],&#34;question&#34;:&#34;Как работает race detector в Go?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Все горутины используют одно и то же значение переменной цикла&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Цикл выполняется слишком долго&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Горутины не могут завершиться&#34;}],&#34;question&#34;:&#34;Что такое проблема &#39;замыкания цикла&#39; в горутинах?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Никакие - все требуют синхронизации при записи&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Только каналы&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Все типы Go&#34;}],&#34;question&#34;:&#34;Какие типы данных можно безопасно использовать в конкурентных программах без дополнительной синхронизации?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Это наименьший по размеру тип данных в Go&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Она быстрее других типов&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Она обязательна для каналов&#34;}],&#34;question&#34;:&#34;Почему пустая структура struct{} используется в каналах для сигналов?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;panic: concurrent map writes или гонки данных при чтении&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Операции выполняются корректно&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Map автоматически синхронизируется&#34;}],&#34;question&#34;:&#34;Что происходит при одновременном чтении и записи в map?&#34;,&#34;type&#34;:&#34;single-choice&#34;},{&#34;answers&#34;:[{&#34;correct&#34;:true,&#34;text&#34;:&#34;Гарантирует, что планировщик Go не запустит другие горутины до Unpin&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Блокирует все горутины&#34;},{&#34;correct&#34;:false,&#34;text&#34;:&#34;Увеличивает приоритет горутины&#34;}],&#34;question&#34;:&#34;Как функция runtime_procPin помогает в атомарных операциях?&#34;,&#34;type&#34;:&#34;single-choice&#34;}]}">
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="0">
      <h5 class="mb-3">1. Что происходит, когда несколько горутин увеличивают переменную-счётчик без синхронизации?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-0" 
                 value="0"
                 id="q0-a0">
          <label class="form-check-label" for="q0-a0">
            Значение счётчика будет меньше ожидаемого из-за гонок данных
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-0" 
                 value="1"
                 id="q0-a1">
          <label class="form-check-label" for="q0-a1">
            Программа вызовет панику
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-0" 
                 value="2"
                 id="q0-a2">
          <label class="form-check-label" for="q0-a2">
            Счётчик всегда будет правильным
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="1">
      <h5 class="mb-3">2. Какая ошибка возникает, когда несколько горутин записывают в карту одновременно?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-1" 
                 value="0"
                 id="q1-a0">
          <label class="form-check-label" for="q1-a0">
            panic: concurrent map writes
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-1" 
                 value="1"
                 id="q1-a1">
          <label class="form-check-label" for="q1-a1">
            Карта будет пустой
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-1" 
                 value="2"
                 id="q1-a2">
          <label class="form-check-label" for="q1-a2">
            Ошибки нет, но результаты неверны
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="2">
      <h5 class="mb-3">3. Каковы решения для потокобезопасных операций со счётчиком?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" 
                 name="question-2" 
                 value="0"
                 id="q2-a0">
          <label class="form-check-label" for="q2-a0">
            Использование `sync.Mutex`
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" 
                 name="question-2" 
                 value="1"
                 id="q2-a1">
          <label class="form-check-label" for="q2-a1">
            Использование каналов
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" 
                 name="question-2" 
                 value="2"
                 id="q2-a2">
          <label class="form-check-label" for="q2-a2">
            Использование пакета atomic
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" 
                 name="question-2" 
                 value="3"
                 id="q2-a3">
          <label class="form-check-label" for="q2-a3">
            Использование обычных переменных
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="3">
      <h5 class="mb-3">4. Как можно обнаружить гонки данных в программах Go?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-3" 
                 value="0"
                 id="q3-a0">
          <label class="form-check-label" for="q3-a0">
            Используя go test -race или go build -race
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-3" 
                 value="1"
                 id="q3-a1">
          <label class="form-check-label" for="q3-a1">
            Используя go vet
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-3" 
                 value="2"
                 id="q3-a2">
          <label class="form-check-label" for="q3-a2">
            Используя gofmt
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="4">
      <h5 class="mb-3">5. Что происходит при параллельной записи в срез без синхронизации?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-4" 
                 value="0"
                 id="q4-a0">
          <label class="form-check-label" for="q4-a0">
            Количество элементов будет меньше ожидаемого из-за гонок данных
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-4" 
                 value="1"
                 id="q4-a1">
          <label class="form-check-label" for="q4-a1">
            Программа вызовет панику
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-4" 
                 value="2"
                 id="q4-a2">
          <label class="form-check-label" for="q4-a2">
            Срез всегда будет содержать все элементы
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="5">
      <h5 class="mb-3">6. Почему операция инкремента (c&#43;&#43;) не является атомарной?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-5" 
                 value="0"
                 id="q5-a0">
          <label class="form-check-label" for="q5-a0">
            Она состоит из трёх шагов: чтение, увеличение, запись
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-5" 
                 value="1"
                 id="q5-a1">
          <label class="form-check-label" for="q5-a1">
            Go не поддерживает атомарные операции
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-5" 
                 value="2"
                 id="q5-a2">
          <label class="form-check-label" for="q5-a2">
            Операция всегда атомарна
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="6">
      <h5 class="mb-3">7. В чём разница между sync.Mutex и sync.RWMutex?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-6" 
                 value="0"
                 id="q6-a0">
          <label class="form-check-label" for="q6-a0">
            RWMutex позволяет параллельные чтения, Mutex блокирует все операции
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-6" 
                 value="1"
                 id="q6-a1">
          <label class="form-check-label" for="q6-a1">
            RWMutex быстрее Mutex
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-6" 
                 value="2"
                 id="q6-a2">
          <label class="form-check-label" for="q6-a2">
            Нет разницы
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="7">
      <h5 class="mb-3">8. Почему операции с каналами являются атомарными?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-7" 
                 value="0"
                 id="q7-a0">
          <label class="form-check-label" for="q7-a0">
            Это встроенная функциональность Go
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-7" 
                 value="1"
                 id="q7-a1">
          <label class="form-check-label" for="q7-a1">
            Каналы используют Mutex внутри
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-7" 
                 value="2"
                 id="q7-a2">
          <label class="form-check-label" for="q7-a2">
            Каналы работают только в одной горутине
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="8">
      <h5 class="mb-3">9. Какие функции предоставляет пакет atomic для работы со счётчиками?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" 
                 name="question-8" 
                 value="0"
                 id="q8-a0">
          <label class="form-check-label" for="q8-a0">
            AddInt32
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" 
                 name="question-8" 
                 value="1"
                 id="q8-a1">
          <label class="form-check-label" for="q8-a1">
            AddInt64
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" 
                 name="question-8" 
                 value="2"
                 id="q8-a2">
          <label class="form-check-label" for="q8-a2">
            LoadInt32
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" 
                 name="question-8" 
                 value="3"
                 id="q8-a3">
          <label class="form-check-label" for="q8-a3">
            SetInt32
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="9">
      <h5 class="mb-3">10. Как работает race detector в Go?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-9" 
                 value="0"
                 id="q9-a0">
          <label class="form-check-label" for="q9-a0">
            Отслеживает одновременный доступ к одной и той же памяти
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-9" 
                 value="1"
                 id="q9-a1">
          <label class="form-check-label" for="q9-a1">
            Проверяет синтаксис кода
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-9" 
                 value="2"
                 id="q9-a2">
          <label class="form-check-label" for="q9-a2">
            Анализирует производительность
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="10">
      <h5 class="mb-3">11. Что такое проблема &#39;замыкания цикла&#39; в горутинах?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-10" 
                 value="0"
                 id="q10-a0">
          <label class="form-check-label" for="q10-a0">
            Все горутины используют одно и то же значение переменной цикла
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-10" 
                 value="1"
                 id="q10-a1">
          <label class="form-check-label" for="q10-a1">
            Цикл выполняется слишком долго
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-10" 
                 value="2"
                 id="q10-a2">
          <label class="form-check-label" for="q10-a2">
            Горутины не могут завершиться
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="11">
      <h5 class="mb-3">12. Какие типы данных можно безопасно использовать в конкурентных программах без дополнительной синхронизации?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-11" 
                 value="0"
                 id="q11-a0">
          <label class="form-check-label" for="q11-a0">
            Никакие - все требуют синхронизации при записи
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-11" 
                 value="1"
                 id="q11-a1">
          <label class="form-check-label" for="q11-a1">
            Только каналы
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-11" 
                 value="2"
                 id="q11-a2">
          <label class="form-check-label" for="q11-a2">
            Все типы Go
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="12">
      <h5 class="mb-3">13. Почему пустая структура struct{} используется в каналах для сигналов?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-12" 
                 value="0"
                 id="q12-a0">
          <label class="form-check-label" for="q12-a0">
            Это наименьший по размеру тип данных в Go
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-12" 
                 value="1"
                 id="q12-a1">
          <label class="form-check-label" for="q12-a1">
            Она быстрее других типов
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-12" 
                 value="2"
                 id="q12-a2">
          <label class="form-check-label" for="q12-a2">
            Она обязательна для каналов
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="13">
      <h5 class="mb-3">14. Что происходит при одновременном чтении и записи в map?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-13" 
                 value="0"
                 id="q13-a0">
          <label class="form-check-label" for="q13-a0">
            panic: concurrent map writes или гонки данных при чтении
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-13" 
                 value="1"
                 id="q13-a1">
          <label class="form-check-label" for="q13-a1">
            Операции выполняются корректно
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-13" 
                 value="2"
                 id="q13-a2">
          <label class="form-check-label" for="q13-a2">
            Map автоматически синхронизируется
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    <div class="quiz-question mb-4 p-3 border rounded" data-question-index="14">
      <h5 class="mb-3">15. Как функция runtime_procPin помогает в атомарных операциях?</h5>
      
      
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-14" 
                 value="0"
                 id="q14-a0">
          <label class="form-check-label" for="q14-a0">
            Гарантирует, что планировщик Go не запустит другие горутины до Unpin
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-14" 
                 value="1"
                 id="q14-a1">
          <label class="form-check-label" for="q14-a1">
            Блокирует все горутины
          </label>
        </div>
        
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" 
                 name="question-14" 
                 value="2"
                 id="q14-a2">
          <label class="form-check-label" for="q14-a2">
            Увеличивает приоритет горутины
          </label>
        </div>
        
      
      
      <div class="quiz-feedback mt-2" style="display: none;"></div>
    </div>
    
    
    <button type="button" class="btn btn-primary" id="check-answers">
      Проверить ответы
    </button>
    <button type="button" class="btn btn-secondary ml-2" id="reset-quiz" style="display: none;">
      Сбросить
    </button>
  </form>
  
  <div id="quiz-results" class="mt-4" style="display: none;">
    <div class="alert" role="alert"></div>
  </div>
</div>

<script>
(function() {
  try {
    const quizContainer = document.getElementById('article-quiz');
    const form = document.getElementById('quiz-form');
    const checkBtn = document.getElementById('check-answers');
    const resetBtn = document.getElementById('reset-quiz');
    const resultsDiv = document.getElementById('quiz-results');
    
    if (!quizContainer || !form || !checkBtn) {
      console.error('Quiz initialization failed: missing elements', {
        quizContainer: !!quizContainer,
        form: !!form,
        checkBtn: !!checkBtn
      });
      return;
    }
    
    const lang = quizContainer.getAttribute('data-quiz-lang') || 'en';
    const quizDataRaw = form.getAttribute('data-quiz-data');
    
    if (!quizDataRaw) {
      console.error('Quiz data not found in data attribute');
      return;
    }
    
    let quizData;
    try {
      quizData = JSON.parse(quizDataRaw);
    } catch (e) {
      console.error('Failed to parse quiz data:', e, quizDataRaw);
      return;
    }
    
    if (!quizData || !quizData.questions || !Array.isArray(quizData.questions)) {
      console.error('Invalid quiz data structure:', quizData);
      return;
    }
    
    
    console.log('Quiz data loaded:', quizData);
  
    function arraysEqual(a, b) {
      if (!a || !b) return false;
      if (a.length !== b.length) return false;
      const sortedA = [...a].sort();
      const sortedB = [...b].sort();
      return sortedA.every((val, i) => val === sortedB[i]);
    }
    
    checkBtn.addEventListener('click', function() {
    if (!quizData.questions || !Array.isArray(quizData.questions)) {
      console.error('Invalid quiz data structure');
      return;
    }
    
    let correctCount = 0;
    let totalQuestions = quizData.questions.length;
    
    quizData.questions.forEach((question, qIndex) => {
      const questionDiv = form.querySelector(`[data-question-index="${qIndex}"]`);
      if (!questionDiv) {
        console.error('Question div not found for index:', qIndex);
        return;
      }
      
      const feedbackDiv = questionDiv.querySelector('.quiz-feedback');
      if (!feedbackDiv) {
        console.error('Feedback div not found for question:', qIndex);
        return;
      }
      
      if (question.type === 'multiple-choice' || question.type === 'single-choice') {
        if (!question.answers || !Array.isArray(question.answers)) {
          console.error('Invalid answers for question:', qIndex);
          return;
        }
        
        const inputs = questionDiv.querySelectorAll(`input[name="question-${qIndex}"]`);
        const selectedAnswers = Array.from(inputs)
          .filter(input => input.checked)
          .map(input => parseInt(input.value));
        
        const correctAnswers = question.answers
          .map((answer, index) => answer.correct === true ? index : -1)
          .filter(index => index !== -1);
        
        const isCorrect = arraysEqual(selectedAnswers, correctAnswers);
        
        if (isCorrect) {
          correctCount++;
          feedbackDiv.innerHTML = '<span class="text-success">✓ ' + (lang === 'ru' ? 'Правильно!' : 'Correct!') + '</span>';
          feedbackDiv.style.display = 'block';
          inputs.forEach(input => {
            const answerIndex = parseInt(input.value);
            const answer = question.answers[answerIndex];
            if (!answer) return;
            
            if (input.checked && answer.correct === true) {
              input.parentElement.classList.add('text-success');
            } else if (input.checked && answer.correct !== true) {
              input.parentElement.classList.add('text-danger');
            } else if (!input.checked && answer.correct === true) {
              input.parentElement.classList.add('text-warning');
            }
          });
        } else {
          feedbackDiv.innerHTML = '<span class="text-danger">✗ ' + (lang === 'ru' ? 'Неправильно' : 'Incorrect') + '</span>';
          feedbackDiv.style.display = 'block';
          inputs.forEach(input => {
            const answerIndex = parseInt(input.value);
            const answer = question.answers[answerIndex];
            if (!answer) return;
            
            if (input.checked && answer.correct !== true) {
              input.parentElement.classList.add('text-danger');
            } else if (!input.checked && answer.correct === true) {
              input.parentElement.classList.add('text-warning');
            }
          });
        }
      } else if (question.type === 'text') {
        const textarea = questionDiv.querySelector('textarea');
        const correctAnswerDiv = questionDiv.querySelector('[data-correct-answer]');
        
        if (!textarea || !question.correct_answer) {
          console.error('Invalid text question:', qIndex);
          return;
        }
        
        if (textarea.value.trim().toLowerCase() === question.correct_answer.toLowerCase()) {
          correctCount++;
          feedbackDiv.innerHTML = '<span class="text-success">✓ ' + (lang === 'ru' ? 'Правильно!' : 'Correct!') + '</span>';
          feedbackDiv.style.display = 'block';
        } else {
          feedbackDiv.innerHTML = '<span class="text-danger">✗ ' + (lang === 'ru' ? 'Неправильно' : 'Incorrect') + '</span>';
          feedbackDiv.style.display = 'block';
          if (correctAnswerDiv) {
            correctAnswerDiv.style.display = 'block';
          }
        }
      }
    });
    
    const percentage = Math.round((correctCount / totalQuestions) * 100);
    const alertClass = percentage >= 70 ? 'alert-success' : percentage >= 50 ? 'alert-warning' : 'alert-danger';
    const message = (lang === 'ru' ? 'Вы ответили правильно на ' : 'You got ') + 
                   correctCount + (lang === 'ru' ? ' из ' : ' out of ') + 
                   totalQuestions + (lang === 'ru' ? ' вопросов (' : ' questions (') + 
                   percentage + '%)';
    
    const alertElement = resultsDiv.querySelector('.alert');
    if (alertElement) {
      alertElement.className = 'alert ' + alertClass;
      alertElement.textContent = message;
    }
      resultsDiv.style.display = 'block';
      checkBtn.style.display = 'none';
      if (resetBtn) {
        resetBtn.style.display = 'inline-block';
      }
    });
    
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        form.reset();
        form.querySelectorAll('.quiz-feedback').forEach(el => el.style.display = 'none');
        form.querySelectorAll('.text-success, .text-danger, .text-warning').forEach(el => {
          el.classList.remove('text-success', 'text-danger', 'text-warning');
        });
        form.querySelectorAll('[data-correct-answer]').forEach(el => el.style.display = 'none');
        resultsDiv.style.display = 'none';
        checkBtn.style.display = 'inline-block';
        resetBtn.style.display = 'none';
      });
    }
  } catch (error) {
    console.error('Quiz script error:', error);
  }
})();
</script>



    
    <hr class="mt-5 mb-4">
    <h3 class="mb-4">Похожие статьи</h3>
    <div class="row">
      <div class="col-md-6 mb-4">
        <div class="card h-100 bg-light rounded" style="border: none;">
          <div class="card-body">
            <span style="color: #aaa; font-size: 0.9em;">


  2 мая 2020 г.


</span>
            <h4 class="card-title mt-2">
              <a href="/ru/post/sync-map.html" style="text-decoration: none; color: inherit;">sync.Map</a>
            </h4>
            
            
            
            <a href="/ru/post/sync-map.html">
              <img class="card-img-top mb-3 rounded"
                   src="/en/post/sync-map/dvoe.svg"
                   style="max-height: 200px;"
                   alt="sync.Map"/>
            </a>
            
            
            <p class="card-text"><p>Давайте рассмотрим использование <code>sync.Map</code> и его исходный код.</p></p>
            
            <a href="/ru/post/sync-map.html" class="btn btn-primary btn-sm">Read More →</a>
                  <a href="/ru/tags/sync.map/" class="badge">Sync.map</a>
                  <a href="/ru/tags/map/" class="badge">Map</a>
                  <a href="/ru/tags/concurrency/" class="badge">Concurrency</a>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-4">
        <div class="card h-100 bg-light rounded" style="border: none;">
          <div class="card-body">
            <span style="color: #aaa; font-size: 0.9em;">


  9 апреля 2020 г.


</span>
            <h4 class="card-title mt-2">
              <a href="/ru/post/templates.html" style="text-decoration: none; color: inherit;">Шаблоны GO: принципы и использование</a>
            </h4>
            
            
            
            <a href="/ru/post/templates.html">
              <img class="card-img-top mb-3 rounded"
                   src="/en/post/templates/lis.svg"
                   style="max-height: 200px;"
                   alt="Шаблоны GO: принципы и использование"/>
            </a>
            
            
            <p class="card-text"><p>Пакеты <code>text/template</code> и <code>html/template</code> являются частью стандартной библиотеки Go. Шаблоны Go используются во многих программах, написанных на Go — Docker, Kubernetes, Helm. Многие сторонние библиотеки интегрированы с шаблонами Go, например Echo. Знание синтаксиса шаблонов Go очень полезно.</p>
<p>Эта статья состоит из документации пакета <code>text/template</code> и нескольких решений автора. После описания синтаксиса шаблонов Go мы погрузимся в исходники <code>text/template</code> и <code>html/template</code>.</p></p>
            
            <a href="/ru/post/templates.html" class="btn btn-primary btn-sm">Read More →</a>
                  <a href="/ru/tags/templates/" class="badge">Templates</a>
                  <a href="/ru/tags/html/" class="badge">Html</a>
                  <a href="/ru/tags/text/" class="badge">Text</a>
                  <a href="/ru/tags/sources/" class="badge">Sources</a>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-4">
        <div class="card h-100 bg-light rounded" style="border: none;">
          <div class="card-body">
            <span style="color: #aaa; font-size: 0.9em;">


  4 апреля 2020 г.


</span>
            <h4 class="card-title mt-2">
              <a href="/ru/post/golang-slice.html" style="text-decoration: none; color: inherit;">Принципы работы типа slice в GO</a>
            </h4>
            
            
            
            <a href="/ru/post/golang-slice.html">
              <img class="card-img-top mb-3 rounded"
                   src="/en/post/golang-slice/gophslice.svg"
                   style="max-height: 200px;"
                   alt="Принципы работы типа slice в GO"/>
            </a>
            
            
            <p class="card-text"><p>В блоге Go описывается, как использовать срезы. Давайте посмотрим на внутреннее устройство срезов.</p></p>
            
            <a href="/ru/post/golang-slice.html" class="btn btn-primary btn-sm">Read More →</a>
                  <a href="/ru/tags/slice/" class="badge">Slice</a>
                  <a href="/ru/tags/allocation/" class="badge">Allocation</a>
                  <a href="/ru/tags/sources/" class="badge">Sources</a>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-4">
        <div class="card h-100 bg-light rounded" style="border: none;">
          <div class="card-body">
            <span style="color: #aaa; font-size: 0.9em;">


  2 апреля 2020 г.


</span>
            <h4 class="card-title mt-2">
              <a href="/ru/post/map-principles-golang.html" style="text-decoration: none; color: inherit;">Принципы работы типа map в GO</a>
            </h4>
            
            
            
            <a href="/ru/post/map-principles-golang.html">
              <img class="card-img-top mb-3 rounded"
                   src="/en/post/map-principles-golang/map.svg"
                   style="max-height: 200px;"
                   alt="Принципы работы типа map в GO"/>
            </a>
            
            
            <p class="card-text"><p>Программный интерфейс map в Go описан в блоге Go. Нам просто нужно вспомнить, что map — это хранилище ключ-значение, и оно должно извлекать значения по ключу как можно быстрее.</p></p>
            
            <a href="/ru/post/map-principles-golang.html" class="btn btn-primary btn-sm">Read More →</a>
                  <a href="/ru/tags/map/" class="badge">Map</a>
                  <a href="/ru/tags/sources/" class="badge">Sources</a>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-4">
        <div class="card h-100 bg-light rounded" style="border: none;">
          <div class="card-body">
            <span style="color: #aaa; font-size: 0.9em;">


  30 марта 2020 г.


</span>
            <h4 class="card-title mt-2">
              <a href="/ru/post/golang-regexp-matching-newline.html" style="text-decoration: none; color: inherit;">Golang regexp: сопоставление символа новой строки</a>
            </h4>
            
            
            
            <a href="/ru/post/golang-regexp-matching-newline.html">
              <img class="card-img-top mb-3 rounded"
                   src="/en/post/golang-regexp-matching-newline/regular.svg"
                   style="max-height: 200px;"
                   alt="Golang regexp: сопоставление символа новой строки"/>
            </a>
            
            
            <p class="card-text"><p>Почему регулярные выражения с точкой (&quot;.&quot;) работают по-другому в Go по сравнению с PHP и JavaScript.</p></p>
            
            <a href="/ru/post/golang-regexp-matching-newline.html" class="btn btn-primary btn-sm">Read More →</a>
                  <a href="/ru/tags/regular-expressions/" class="badge">Regular Expressions</a>
                  <a href="/ru/tags/sources/" class="badge">Sources</a>
          </div>
        </div>
      </div>
    </div>


    <script defer src="/discuss.js"></script>
    <div id="discuss"></div>
</div>

</div>

<div class="bg-light">&nbsp;</div>

<footer>
    <div class="container " style="padding-top: 0; padding-bottom: 10px;">
    <div class="container">
        <img src="/niz.svg" alt="gopher legs" style="height: 50px; vertical-align: top;"/>
        <div style="text-align: right; vertical-align: top; display: inline-block;">
            
            &nbsp;
            &nbsp;
            &nbsp;
            
            
            <a href='/en/post/golang-data-handling-concurrent-programs.html'>
            <span class="flag-icon flag-icon-us"></span>
            </a>
            
        </div>

    </div>
</div>

</footer>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script defer src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html>
